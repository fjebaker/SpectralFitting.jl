<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Why &amp; How · SpectralFitting.jl</title><meta name="title" content="Why &amp; How · SpectralFitting.jl"/><meta property="og:title" content="Why &amp; How · SpectralFitting.jl"/><meta property="twitter:title" content="Why &amp; How · SpectralFitting.jl"/><meta name="description" content="Documentation for SpectralFitting.jl."/><meta property="og:description" content="Documentation for SpectralFitting.jl."/><meta property="twitter:description" content="Documentation for SpectralFitting.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="SpectralFitting.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpectralFitting.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../walkthrough/">Walkthrough</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../examples/examples/">Diverse examples</a></li><li><a class="tocitem" href="../examples/sherpa-example/">A quick guide</a></li></ul></li><li><span class="tocitem">Models</span><ul><li><a class="tocitem" href="../models/using-models/">Using models</a></li><li><a class="tocitem" href="../models/models/">Model index</a></li><li><a class="tocitem" href="../models/composite-models/">Composite models</a></li><li><a class="tocitem" href="../models/surrogate-models/">Surrogate models</a></li></ul></li><li><span class="tocitem">Datasets</span><ul><li><a class="tocitem" href="../datasets/datasets/">Using datasets</a></li><li><a class="tocitem" href="../datasets/mission-support/">Mission support</a></li></ul></li><li class="is-active"><a class="tocitem" href>Why &amp; How</a><ul class="internal"><li><a class="tocitem" href="#Rewriting-model-calls-during-invocation"><span>Rewriting model calls during invocation</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Why &amp; How</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Why &amp; How</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/fjebaker/SpectralFitting.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/fjebaker/SpectralFitting.jl/blob/main/docs/src/why-and-how.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Why-and-how"><a class="docs-heading-anchor" href="#Why-and-how">Why &amp; how</a><a id="Why-and-how-1"></a><a class="docs-heading-anchor-permalink" href="#Why-and-how" title="Permalink"></a></h1><p>SpectralFitting.jl is a package for fitting models to spectral data, similar to <a href="https://heasarc.gsfc.nasa.gov/xanadu/xspec/">XSPEC</a>, <a href="https://sherpa.readthedocs.io/en/latest/ciao.html">Sherpa</a> or <a href="https://space.mit.edu/CXC/isis/">ISIS</a>.</p><p>The rationale for this package is to provide a unanimous interface for different model libraries, and to leverage advancements in the computional methods that are available in Julia, including the rich statistics ecosystem, with <a href="https://en.wikipedia.org/wiki/Automatic_differentiation">automatic-differentiation</a> and <a href="https://julialang.org/benchmarks/"><em>speed</em></a>.</p><p>Longer term ambitions include</p><ul><li>Multi-wavelength fits</li><li>Radiative transfer embedded into the package</li><li>Spectral and timing fits</li></ul><p>SpectralFitting aims to provide highly optimised and flexible fitting algorithms, along with a library of spectral models, for use in any field of Astronomy that concerns itself with spectral data.</p><h2 id="Rewriting-model-calls-during-invocation"><a class="docs-heading-anchor" href="#Rewriting-model-calls-during-invocation">Rewriting model calls during invocation</a><a id="Rewriting-model-calls-during-invocation-1"></a><a class="docs-heading-anchor-permalink" href="#Rewriting-model-calls-during-invocation" title="Permalink"></a></h2><p>SpectralFitting.jl tries to optimise model invocation through source-rewriting. For compatibility with the XSPEC model library, this is achieved through aggressive pre-allocation and shuffling of output vectors. All XSPEC models output the result of their calculation through side effects into a flux array passed as an argument, and therefore each model invocation requires its own output before addition or multiplication of fluxes may occur.</p><p>Principally, combining several models together would look like this:</p><pre><code class="language-julia hljs">energy = collect(range(0.1, 20.0, 100))

flux1 = invokemodel(energy, XS_PowerLaw())
flux2 = invokemodel(energy, XS_PowerLaw(a=FitParam(3.0)))
flux3 = invokemodel(energy, XS_BlackBody())
flux4 = invokemodel(energy, XS_PhotoelectricAbsorption())

total_flux = @. flux4 * (flux1 + flux2 + flux3)
sum(total_flux)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">8.296695648865288</code></pre><p>But these operations could also be performed in a different order:</p><pre><code class="language-julia hljs">flux1 = invokemodel(energy, XS_PowerLaw())
flux2 = invokemodel(energy, XS_PowerLaw(a=FitParam(3.0)))
total_flux = @. flux1 + flux2

flux3 = invokemodel(energy, XS_BlackBody())
@. total_flux = total_flux + flux3

flux4 = invokemodel(energy, XS_PhotoelectricAbsorption())
@. total_flux = total_flux * flux4
sum(total_flux)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">8.296695648865288</code></pre><p>Doing so would allow us to only pre-allocate 2 flux arrays, instead of 4 when using the in-place variants:</p><pre><code class="language-julia hljs">fluxes = zeros(Float64, (length(energy) - 1, 2))
flux1, flux2 = eachcol(fluxes)

invokemodel!(flux1, energy, XS_PowerLaw())
invokemodel!(flux2, energy, XS_PowerLaw(a=FitParam(3.0)))
@. flux1 = flux1 + flux2

invokemodel!(flux2, energy, XS_BlackBody())
@. flux1 = flux1 + flux2

invokemodel!(flux2, energy, XS_PhotoelectricAbsorption())
@. flux1 = flux1 * flux2
sum(flux1)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">8.296695648865288</code></pre><p>It is precisely this re-writing that SpectralFitting performs via <a href="https://docs.julialang.org/en/v1/manual/metaprogramming/#Generated-functions"><code>@generated</code></a> functions. We can inspect the code used to generate the invocation body after defining a <a href="../models/composite-models/#SpectralFitting.CompositeModel"><code>CompositeModel</code></a>:</p><pre><code class="language-julia hljs">model = XS_PhotoelectricAbsorption() * (
    XS_PowerLaw() + XS_PowerLaw(a=FitParam(3.0)) + XS_BlackBody()
)

params = get_value.(SpectralFitting.parameter_tuple(model))
SpectralFitting.Reflection.assemble_composite_model_call(typeof(model), typeof(params))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">quote
    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:338 =#</span>
    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:338 =#</span> @fastmath begin
            <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:339 =#</span>
            <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:339 =#</span> @inbounds let objective1 = view(objectives, :, 1), objective2 = view(objectives, :, 2), objective3 = view(objectives, :, 3)
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:340 =#</span>
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:341 =#</span>
                    var&quot;##K#531&quot; = parameters[1]
                    var&quot;##T#532&quot; = parameters[2]
                    var&quot;##K#533&quot; = parameters[3]
                    var&quot;##a#534&quot; = parameters[4]
                    var&quot;##K#535&quot; = parameters[5]
                    var&quot;##a#536&quot; = parameters[6]
                    var&quot;##ηH#537&quot; = parameters[7]
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:342 =#</span>
                    invokemodel!(objective1, domain, (XS_BlackBody){Float64}(var&quot;##K#531&quot;, var&quot;##T#532&quot;))
                    invokemodel!(objective2, domain, (XS_PowerLaw){Float64}(var&quot;##K#533&quot;, var&quot;##a#534&quot;))
                    invokemodel!(objective3, domain, (XS_PowerLaw){Float64}(var&quot;##K#535&quot;, var&quot;##a#536&quot;))
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:282 =#</span> @__dot__ objective2 = objective2 + objective3
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:282 =#</span> @__dot__ objective1 = objective1 + objective2
                    invokemodel!(objective2, domain, (XS_PhotoelectricAbsorption){Float64}(var&quot;##ηH#537&quot;))
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:282 =#</span> @__dot__ objective1 = objective1 * objective2
                    <span class="sgr90">#= /home/runner/work/SpectralFitting.jl/SpectralFitting.jl/src/reflection.jl:343 =#</span>
                    return objective1
                end
        end
end</code></pre><p>This generated function also takes care of some other things for us, such as unpacking parameters (optionally unpacking frozen parameters separately), and ensuring any closure are passed to <a href="../models/using-models/#SpectralFitting.invokemodel"><code>invokemodel</code></a> if a model needs them (e.g., <a href="../models/surrogate-models/#SpectralFitting.SurrogateSpectralModel"><code>SurrogateSpectralModel</code></a>).</p><p>This is achieved by moving as much information as possible about the model and its construction to its type, such that all of the invocation and parameter unpacking may be inferred at compile time.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>With the addition of more pure-Julia models, non-allocating methods without aggressive pre-allocation are possible, and will be added in the future. Such methods may allow models to add or multiply in-place on the total flux array, instead of relying on later broadcasts.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../datasets/mission-support/">« Mission support</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 1 October 2024 21:45">Tuesday 1 October 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
